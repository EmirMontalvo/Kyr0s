<div class="calendar-container">
    <div class="sidebar">
        <mat-card class="datepicker-card">
            <mat-calendar [(selected)]="selectedDate" (selectedChange)="onDateChange($event)">
            </mat-calendar>
        </mat-card>

        <div class="branch-filter">
            <button mat-stroked-button color="primary" (click)="openBranchSelector()" class="filter-btn"
                *ngIf="!isBranchUser">
                <mat-icon>filter_list</mat-icon>
                Filtrar Sucursal
            </button>
            <p class="selected-branch">
                <mat-icon inline>store</mat-icon>
                {{ isBranchUser ? branchName : getSelectedBranchName() }}
            </p>
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <h2>Agenda del {{ selectedDate | date:'fullDate' }}</h2>
            <button mat-fab extended color="primary" (click)="openDialog()" [disabled]="isPastDate()">
                <mat-icon>add</mat-icon>
                Nueva Cita
            </button>
        </div>

        <div class="loading-container" *ngIf="loading">
            <video autoplay loop [muted]="true" playsinline>
                <source src="assets/loading.mp4" type="video/mp4">
            </video>
        </div>

        <div class="citas-list">
            <div *ngIf="citas.length === 0" class="empty-state">
                <mat-icon>event_busy</mat-icon>
                <p>No hay citas programadas para este d√≠a.</p>
            </div>

            <mat-card *ngFor="let cita of citas" class="cita-card" [class.en-proceso]="cita.estado === 'en_proceso'"
                [style.border-left-color]="cita.estado === 'pendiente' ? '#1976d2' : cita.estado === 'completada' ? '#388e3c' : cita.estado === 'cancelada' ? '#d32f2f' : ''">
                <div class="time-column">
                    <span class="start-time">{{ formatTime(cita.fecha_hora_inicio) }}</span>
                    <span class="end-time">{{ formatTime(cita.fecha_hora_fin) }}</span>
                </div>
                <div class="info-column">
                    <h3>{{ getClienteNombre(cita) }}</h3>
                    <p class="services">{{ getServiciosNombres(cita) }}</p>
                    <p class="price" *ngIf="getTotalPrecio(cita) > 0">
                        Total: ${{ getTotalPrecio(cita) }}
                    </p>
                    <p class="employee">
                        <mat-icon inline>person</mat-icon>
                        {{ cita.empleados?.nombre || 'Sin asignar' }}
                    </p>
                </div>
                <div class="status-column">
                    <span class="status-badge" [class]="cita.estado">{{ cita.estado }}</span>

                    <div class="actions">
                        <button mat-icon-button color="primary" (click)="openDialog(cita)" matTooltip="Editar">
                            <mat-icon>edit</mat-icon>
                        </button>
                        <button mat-icon-button color="accent" *ngIf="cita.estado !== 'completada'"
                            (click)="updateStatus(cita, 'completada')" matTooltip="Completar">
                            <mat-icon>check_circle</mat-icon>
                        </button>
                        <button mat-icon-button color="warn" *ngIf="cita.estado !== 'cancelada'"
                            (click)="updateStatus(cita, 'cancelada')" matTooltip="Cancelar">
                            <mat-icon>cancel</mat-icon>
                        </button>
                    </div>
                </div>
            </mat-card>
        </div>
    </div>
</div>