<div class="statistics-container">
    <h2>Estadísticas</h2>

    <div class="loading-container" *ngIf="loading">
        <mat-spinner></mat-spinner>
    </div>

    <div class="charts-grid" *ngIf="!loading">
        <!-- Owner: Appointments by Branch -->
        <mat-card *ngIf="isOwner && appointmentsByBranch.length > 0" class="chart-card"
            (click)="openFullscreen('appointments')">
            <mat-card-header>
                <mat-card-title>Citas por Sucursal</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <ngx-charts-bar-vertical [results]="appointmentsByBranch" [xAxis]="true" [yAxis]="true" [legend]="false"
                    [showXAxisLabel]="true" [showYAxisLabel]="true" [xAxisLabel]="'Sucursal'" [yAxisLabel]="'Citas'"
                    [scheme]="colorScheme" [gradient]="true">
                </ngx-charts-bar-vertical>
            </mat-card-content>
        </mat-card>

        <!-- Owner: Popular Services General -->
        <mat-card *ngIf="isOwner && popularServicesGeneral.length > 0" class="chart-card"
            (click)="openFullscreen('services-general')">
            <mat-card-header>
                <mat-card-title>Servicios Más Elegidos (General)</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <ngx-charts-pie-chart [results]="popularServicesGeneral" [legend]="true" [legendTitle]="'Servicios'"
                    [scheme]="colorScheme" [labels]="true" [doughnut]="true">
                </ngx-charts-pie-chart>
            </mat-card-content>
        </mat-card>

        <!-- Owner: Services by Selected Branch -->
        <mat-card *ngIf="isOwner && branches.length > 0" class="chart-card full-width"
            (click)="openFullscreen('services-branch')">
            <mat-card-header>
                <mat-card-title>Servicios por Sucursal</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <mat-form-field appearance="outline" class="branch-select" (click)="$event.stopPropagation()">
                    <mat-label>Seleccionar Sucursal</mat-label>
                    <mat-select [value]="selectedBranchForServices" (selectionChange)="onBranchChange($event.value)">
                        <mat-option *ngFor="let branch of branches" [value]="branch.id">
                            {{ branch.nombre }}
                        </mat-option>
                    </mat-select>
                </mat-form-field>

                <ngx-charts-bar-horizontal *ngIf="servicesByBranch.length > 0" [results]="servicesByBranch"
                    [xAxis]="true" [yAxis]="true" [legend]="false" [showXAxisLabel]="true" [showYAxisLabel]="true"
                    [xAxisLabel]="'Cantidad'" [yAxisLabel]="'Servicio'" [scheme]="colorScheme" [gradient]="true">
                </ngx-charts-bar-horizontal>

                <div *ngIf="servicesByBranch.length === 0" class="no-data">
                    No hay datos de servicios para esta sucursal
                </div>
            </mat-card-content>
        </mat-card>

        <!-- Branch User: Popular Services in their Branch -->
        <mat-card *ngIf="!isOwner && servicesByBranch.length > 0" class="chart-card"
            (click)="openFullscreen('services-branch-user')">
            <mat-card-header>
                <mat-card-title>Servicios Más Elegidos</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <ngx-charts-pie-chart [results]="servicesByBranch" [legend]="true" [legendTitle]="'Servicios'"
                    [scheme]="colorScheme" [labels]="true" [doughnut]="true">
                </ngx-charts-pie-chart>
            </mat-card-content>
        </mat-card>

        <!-- Branch User: Revenue Chart -->
        <mat-card *ngIf="!isOwner" class="chart-card full-width revenue-card">
            <mat-card-header>
                <mat-card-title>
                    <mat-icon>attach_money</mat-icon>
                    Ingresos
                </mat-card-title>
            </mat-card-header>
            <mat-card-content (click)="$event.stopPropagation()">
                <!-- View Mode Toggle -->
                <div class="revenue-controls">
                    <mat-button-toggle-group [value]="revenueViewMode" (change)="setRevenueViewMode($event.value)">
                        <mat-button-toggle value="day">Día</mat-button-toggle>
                        <mat-button-toggle value="week">Semana</mat-button-toggle>
                        <mat-button-toggle value="month">Mes</mat-button-toggle>
                    </mat-button-toggle-group>
                </div>

                <!-- Period Navigation -->
                <div class="period-navigation">
                    <button mat-icon-button (click)="navigatePeriod('prev')">
                        <mat-icon>chevron_left</mat-icon>
                    </button>
                    <span class="period-label">{{ revenuePeriodLabel }}</span>
                    <button mat-icon-button (click)="navigatePeriod('next')">
                        <mat-icon>chevron_right</mat-icon>
                    </button>
                </div>

                <!-- Total Revenue -->
                <div class="revenue-total">
                    <span class="total-label">Total:</span>
                    <span class="total-amount">${{ revenueTotal | number:'1.2-2' }}</span>
                </div>

                <!-- Revenue Chart -->
                <div class="revenue-chart" *ngIf="revenueData.length > 0">
                    <ngx-charts-bar-vertical [results]="revenueData" [xAxis]="true" [yAxis]="true" [legend]="false"
                        [showXAxisLabel]="true" [showYAxisLabel]="true"
                        [xAxisLabel]="revenueViewMode === 'day' ? 'Hora' : (revenueViewMode === 'week' ? 'Día' : 'Día del Mes')"
                        [yAxisLabel]="'Ingresos ($)'" [scheme]="colorScheme" [gradient]="true">
                    </ngx-charts-bar-vertical>
                </div>

                <div *ngIf="revenueData.length === 0 || revenueTotal === 0" class="no-data">
                    <mat-icon>trending_up</mat-icon>
                    <p>No hay ingresos registrados para este período</p>
                    <small>Los ingresos se registran al marcar citas como completadas</small>
                </div>
            </mat-card-content>
        </mat-card>

        <!-- Empty State -->
        <div *ngIf="!loading && appointmentsByBranch.length === 0 && popularServicesGeneral.length === 0 && servicesByBranch.length === 0 && isOwner"
            class="empty-state">
            <mat-icon>bar_chart</mat-icon>
            <h3>Sin datos suficientes</h3>
            <p>Las estadísticas aparecerán cuando haya citas registradas</p>
        </div>
    </div>

    <!-- Fullscreen Modal -->
    <div class="fullscreen-overlay" *ngIf="fullscreenChart" (click)="closeFullscreen()">
        <mat-card class="fullscreen-card" (click)="$event.stopPropagation()">
            <button mat-icon-button class="close-btn" (click)="closeFullscreen()">
                <mat-icon>close</mat-icon>
            </button>

            <!-- Appointments by Branch -->
            <div *ngIf="fullscreenChart === 'appointments'" class="fullscreen-chart">
                <h3>Citas por Sucursal</h3>
                <ngx-charts-bar-vertical [results]="appointmentsByBranch" [xAxis]="true" [yAxis]="true" [legend]="true"
                    [showXAxisLabel]="true" [showYAxisLabel]="true" [xAxisLabel]="'Sucursal'" [yAxisLabel]="'Citas'"
                    [scheme]="colorScheme" [gradient]="true">
                </ngx-charts-bar-vertical>
            </div>

            <!-- Services General -->
            <div *ngIf="fullscreenChart === 'services-general'" class="fullscreen-chart">
                <h3>Servicios Más Elegidos (General)</h3>
                <ngx-charts-pie-chart [results]="popularServicesGeneral" [legend]="true" [legendTitle]="'Servicios'"
                    [scheme]="colorScheme" [labels]="true" [doughnut]="true">
                </ngx-charts-pie-chart>
            </div>

            <!-- Services by Branch (Owner) -->
            <div *ngIf="fullscreenChart === 'services-branch'" class="fullscreen-chart">
                <h3>Servicios por Sucursal</h3>
                <mat-form-field appearance="outline" class="branch-select">
                    <mat-label>Seleccionar Sucursal</mat-label>
                    <mat-select [value]="selectedBranchForServices" (selectionChange)="onBranchChange($event.value)">
                        <mat-option *ngFor="let branch of branches" [value]="branch.id">
                            {{ branch.nombre }}
                        </mat-option>
                    </mat-select>
                </mat-form-field>
                <ngx-charts-bar-horizontal *ngIf="servicesByBranch.length > 0" [results]="servicesByBranch"
                    [xAxis]="true" [yAxis]="true" [legend]="true" [showXAxisLabel]="true" [showYAxisLabel]="true"
                    [xAxisLabel]="'Cantidad'" [yAxisLabel]="'Servicio'" [scheme]="colorScheme" [gradient]="true">
                </ngx-charts-bar-horizontal>
            </div>

            <!-- Services Branch User -->
            <div *ngIf="fullscreenChart === 'services-branch-user'" class="fullscreen-chart">
                <h3>Servicios Más Elegidos</h3>
                <ngx-charts-pie-chart [results]="servicesByBranch" [legend]="true" [legendTitle]="'Servicios'"
                    [scheme]="colorScheme" [labels]="true" [doughnut]="true">
                </ngx-charts-pie-chart>
            </div>
        </mat-card>
    </div>
</div>